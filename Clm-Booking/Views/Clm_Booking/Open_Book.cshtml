@model Clm_Booking.Models.ClientClm

@{
    ViewBag.Title = "Open Book";
}


@section css{

    <style>
        #timepicker:before {
            content: 'Time: HR:MM: AM/PM';
            margin-right: .6em;
            color: #9d9d9d;
        }

        td.Unavailable, table.ui-datepicker-calendar tbody td.Unavailable a {
            background: none !important;
            background-color: red !important;
            color: deeppink !important;
        }

        a {
            text-decoration: none;
        }

            a:hover {
                color: cadetblue;
                text-decoration: none;
            }

        td.ui-datepicker-week-end {
            visibility: hidden;
        }
    </style>

}
<link href="~/Content/bootstrap.min.css" rel="stylesheet" />
<link href="~/Content/themes/base/jquery-ui.min.css" rel="stylesheet" />

<div style="padding:4rem;">
    @using (Html.BeginForm())
    {
        @Html.AntiForgeryToken()

        <div class="container">
            <h4>Schedule Appointment</h4>
            <b style="color:darkred;"> @ViewBag.Success </b>
            <hr />
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
            <div class="form-group">
                @Html.LabelFor(model => model.firstname, htmlAttributes: new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.EditorFor(model => model.firstname, new { htmlAttributes = new { @class = "form-control", placeholder = "First Name" } })
                    @Html.ValidationMessageFor(model => model.firstname, "", new { @class = "text-danger" })
                </div>
            </div>

            <div class="form-group">
                @Html.LabelFor(model => model.lastname, htmlAttributes: new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.EditorFor(model => model.lastname, new { htmlAttributes = new { @class = "form-control", placeholder = "Last Name" } })
                    @Html.ValidationMessageFor(model => model.lastname, "", new { @class = "text-danger" })
                </div>
            </div>

            <div class="form-group">
                @Html.LabelFor(model => model.bookdate, htmlAttributes: new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.EditorFor(model => model.bookdate, new { htmlAttributes = new { @class = "form-control dates", placeholder = "Date" } })
                    @Html.ValidationMessageFor(model => model.bookdate, "", new { @class = "text-danger" })
                </div>
            </div>

            <div class="form-group">
                @Html.LabelFor(model => model.booktime, htmlAttributes: new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.EditorFor(model => model.booktime, new { htmlAttributes = new { @class = "form-control", id = "timepicker", placeholder = "Time" } })
                    @Html.ValidationMessageFor(model => model.booktime, "", new { @class = "text-danger" })
                </div>
            </div>

            <div class="form-group">
                @Html.LabelFor(model => model.email, htmlAttributes: new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.EditorFor(model => model.email, new { htmlAttributes = new { @class = "form-control", placeholder = "Email" } })
                    @Html.ValidationMessageFor(model => model.email, "", new { @class = "text-danger" })
                </div>
            </div>

            <div class="form-group">
                @Html.LabelFor(model => model.phonenumber, htmlAttributes: new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.EditorFor(model => model.phonenumber, new { htmlAttributes = new { @class = "form-control", placeholder = "Phone Number" } })
                    @Html.ValidationMessageFor(model => model.phonenumber, "", new { @class = "text-danger" })
                </div>
            </div>

            <div class="form-group">
                @Html.LabelFor(model => model.comments, htmlAttributes: new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.TextAreaFor(model => model.comments, new { @class = "form-control", cols = "3" })
                    @Html.ValidationMessageFor(model => model.comments, "", new { @class = "text-danger" })
                </div>
            </div>

            <div class="form-group">
                <div class="col-md-offset-2 col-md-10">
                    <input type="submit" value="Book Appointment" class="btn btn-primary" />
                </div>
            </div>
        </div>

        <div class="form-group">
            <p class="control-label timing col-md-2"> Time</p>
            <div class="col-md-10">
                <select id="time-select"></select>
            </div>
        </div>

        <p class="showtime"></p>

    }

</div>

@section Scripts{
    <script>
        $(document).ready(function () {
            var breakTime = ["01:00", "02:00"];
            var unavailableDates;
            var useddate = [];
            var selectedDate;


            $.get("@Url.Action("GetAvailableDate", "Clm_Booking")", function (data) {
                // date gotten from the back
                var date = data.dates;
                 selectedDate = $(".dates").select().val();
                //console.log(selectedDate);

                //loop through all date to format them
                for (var i = 0; i < date.length; i++) {
                    unavailableDates = ToJavaScriptDate(date[i]);
                    //console.log(unavailableDates);    
                    
                    if (selectedDate == unavailableDates) {
                        console.log("Date not available" + " " +unavailableDates);
                    }
                }                

                // This for changing the Data format from Back-side to Client side for Javascript
                function ToJavaScriptDate(date) {
                    var pattern = /Date\(([^)]+)\)/;
                    var results = pattern.exec(date);
                    var dt = new Date(parseFloat(results[1]));

                    return (dt.getMonth() + 1) + "/" + dt.getDate() + "/" + dt.getFullYear();
                }

                // This is the datepicker with callback function
                 $('.dates').datepicker();
            });


            // Time Functions

            function ToJavaScriptTime(time) {
                    var pattern = /Date\(([^)]+)\)/;
                    var results = pattern.exec(time);
                    var dt = new Date(parseFloat(results[1]));

                return (dt.toTimeString());

            }


            var timees = "(@ViewBag.times)"; 

            console.log("from ViewBag" + timees);

            $.get("@Url.Action("GetAllTime","Clm_Booking")", function (times) {
                var time = times.times;


                for (var i = 0; i < time.length; i++) {
                  var unavailableTime = ToJavaScriptTime(time[i]);
                    console.log(unavailableTime);
                }

                $(".showtime").append(time);
            });

            
            var workingTime = ["9:30", "10:00", "10:30", "11:00", "11:30", "12:00","12:30","1:00","3:00","3:30","4:00","4:30","5:00"];
            var bookedTime = ["9:30", "1:00"];

            function arr_diff(a1, a2) {

                var a = [], diff = [];

                for (var i = 0; i < a1.length; i++) {
                    a[a1[i]] = true;
                }

                for (var i = 0; i < a2.length; i++) {
                    if (a[a2[i]]) {
                        delete a[a2[i]];
                    } else {
                        a[a2[i]] = true;
                    }
                }

                for (var k in a) {
                    diff.push(k);
                }

                return diff;
            }

            function appendOptions(time) {
                for (var i = 0; i < time.length; i++) {
                    var timeText = document.createTextNode(time[i]);
                    var option = document.createElement("option");
                    var select = document.getElementById("time-select");
                    option.appendChild(timeText);
                    select.appendChild(option);
                }
            }

            const availableTime = arr_diff(workingTime, bookedTime);
            appendOptions(availableTime);
            // End of Time Functioin

            $('#timepicker').timepicker({
                'minTime': '9:30am',
                'maxTime': '5:00pm',
               // 'disableTimeRanges': [breakTime]
            });

        });

    </script>



}



